---
export const prerender = true; // Keep this line
import Layout from '../../../../../layouts/Layout.astro';
import StructuredData from '../../../../../components/StructuredData.astro';
import { getCollection, type CollectionEntry, render } from 'astro:content';
export async function getStaticPaths() {
const blogEntries = await getCollection('blog');
// --- THIS LINE WAS MISSING/COMMENTED OUT ---
const sortedEntries = blogEntries
  .slice()
  .sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
// ------------------------------------------
return sortedEntries.map((entry: CollectionEntry<'blog'>, index: number) => {
  const pubDate = entry.data.pubDate;
  const year = pubDate.getFullYear().toString();
  const month = (pubDate.getMonth() + 1).toString().padStart(2, '0');
  const day = pubDate.getDate().toString().padStart(2, '0');
  const newerPost: CollectionEntry<'blog'> | undefined = sortedEntries[index - 1];
  const olderPost: CollectionEntry<'blog'> | undefined = sortedEntries[index + 1];
  const cleanSlug = entry.slug.replace(/^\d{4}-\d{2}-\d{2}-/, '');
  return {
    params: { year, month, day, slug: cleanSlug },
    props: { entry, newerPost, olderPost },
  };
});
}

function buildPostUrl(post: CollectionEntry<'blog'>) {
  const pubDate = post.data.pubDate;
  const year = pubDate.getFullYear().toString();
  const month = (pubDate.getMonth() + 1).toString().padStart(2, '0');
  const day = pubDate.getDate().toString().padStart(2, '0');
  const slug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, '');
  return `/blog/${year}/${month}/${day}/${slug}/`;
}

interface Props {
entry: CollectionEntry<'blog'>;
newerPost?: CollectionEntry<'blog'>;
olderPost?: CollectionEntry<'blog'>;
}
const { entry, newerPost, olderPost } = Astro.props as Props;
if (!entry) {
// Entry is undefined, this should not happen in normal operation
}
const { Content } = await render(entry);

// Create description from the content (first 155 characters)
const description = (entry.body || '').substring(0, 155).trim() + (entry.body && entry.body.length > 155 ? '...' : '');

// Create full URL for this blog post
const pubDate = entry.data.pubDate;
const year = pubDate.getFullYear().toString();
const month = (pubDate.getMonth() + 1).toString().padStart(2, '0');
const day = pubDate.getDate().toString().padStart(2, '0');
const cleanSlug = entry.slug.replace(/^\d{4}-\d{2}-\d{2}-/, '');
const blogUrl = `/blog/${year}/${month}/${day}/${cleanSlug}/`;

// Prepare structured data for blog post
const blogSchemaData = {
  title: entry.data.title,
  image: entry.data.main_image || '/images/jmf2-998x665.jpg',
  datePublished: entry.data.pubDate.toISOString(),
  dateModified: entry.data.pubDate.toISOString(),
  description: description,
  url: `https://jeanmarcfavre.com${blogUrl}`
};
---

<Layout 
  title={`${entry.data.title} | Blog Jean-Marc Favre`}
  description={description}
  image={entry.data.main_image || '/images/jmf2-998x665.jpg'}
  canonical={blogUrl}
>
   <StructuredData type="BlogPosting" data={blogSchemaData} />

   <div class="single-post-container">

      <div class="back-link back-link-blog">
         <a href="/blog/">Retour au blog</a>
      </div>

      <article class="article-content">

         <header class="title-wrapper">
            <h1>{entry.data.title}</h1>
            <p class="pub-date post-date">
               <time datetime={entry.data.pubDate.toISOString()}>
               {entry.data.pubDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })}
               </time>
               {entry.data.location && (
               <span class="post-location">
               &nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;{entry.data.location}
               </span>
               )}
            </p>
            {entry.data.tags && (
            <div class="post-tags">
               {Object.entries(entry.data.tags).map(([tagKey, isActive]) => (
               isActive && (
               <span class="tag">{tagKey.charAt(0).toUpperCase() + tagKey.slice(1)}</span>
               )
               ))}
            </div>
            )}
         </header>

         {entry.data.main_image && (
         <figure class="image-wrapper mb-2">
            <img
               class="post-header-image"
               src={entry.data.main_image}
               alt={entry.data.title}
               width="1200"
               height="675"
               />
         </figure>
         )}

         <section class="post-content text-wrapper">
            <Content />
         </section>

         <section class="post-media-extras">
            {entry.data.gallery_url && (
            <div class="post-gallery">
               <div class="gallery-header">
                  <h2 class="visually-hidden">Galerie - {entry.data.title}</h2>
                  <div class="gallery-actions">
                     <button class="gallery-action-btn" onclick={`shareGallery('${entry.data.gallery_url}')`} title="Partager la galerie">
                        <svg viewBox="0 0 24 24">
                           <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                     </button>
                     <a href={entry.data.gallery_url} target="_blank" class="gallery-action-btn" title="Ouvrir dans un nouvel onglet">
                        <svg viewBox="0 0 24 24">
                           <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                        </svg>
                     </a>
                  </div>
               </div>
               <div class="lightroom-gallery">
                  <iframe
                  src={entry.data.gallery_url}
                  width="100%"
                  height="600"
                  frameborder="0"
                  allowfullscreen
                  title={`Lightroom Gallery for ${entry.data.title}`}
                  ></iframe>
               </div>
            </div>
            )}
            {entry.data.video_url && (
            <div class="video-embed-container">
               <iframe
               src={entry.data.video_url.replace("vimeo.com/", "player.vimeo.com/video/")}
               width="100%"
               height="400"
               frameborder="0"
               allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
               allowfullscreen
               title={`Video for ${entry.data.title}`}
               ></iframe>
            </div>
            )}
         </section>
         
      </article>

      {/* Enhanced Navigation - works in both modal and full page */}
      <nav class="post-navigation">
         <div class="navigation-cards">
            <div class="nav-card-wrapper">
               {newerPost ? (
               <a class="nav-card nav-link newer-post" href={buildPostUrl(newerPost)}>
                  <div class="nav-card-direction">← Plus récent</div>
                  <div class="nav-card-body">
                     <div class="nav-card-image">
                        {newerPost.data.main_image && (
                           <img src={newerPost.data.main_image} alt={newerPost.data.title} loading="lazy" />
                        )}
                     </div>
                     <div class="nav-card-content">
                        <h3 class="nav-card-title">{newerPost.data.title}</h3>
                        <div class="nav-card-meta">
                           <time>{newerPost.data.pubDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' })}</time>{newerPost.data.location && <span>&nbsp;&nbsp;//&nbsp;&nbsp;{newerPost.data.location}</span>}
                        </div>
                     </div>
                  </div>
               </a>
               ) : (
               <div class="nav-card nav-card-empty newer-post">
                  <div class="nav-card-direction">← Plus récent</div>
                  <div class="nav-card-empty-message">Pas d'article plus récent</div>
               </div>
               )}
            </div>

            <div class="nav-card-wrapper">
               {olderPost ? (
               <a class="nav-card nav-link older-post" href={buildPostUrl(olderPost)}>
                  <div class="nav-card-direction">Plus ancien →</div>
                  <div class="nav-card-body">
                     <div class="nav-card-content">
                        <h3 class="nav-card-title">{olderPost.data.title}</h3>
                        <div class="nav-card-meta">
                           <time>{olderPost.data.pubDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' })}</time>{olderPost.data.location && <span>&nbsp;&nbsp;//&nbsp;&nbsp;{olderPost.data.location}</span>}
                        </div>
                     </div>
                     <div class="nav-card-image">
                        {olderPost.data.main_image && (
                           <img src={olderPost.data.main_image} alt={olderPost.data.title} loading="lazy" />
                        )}
                     </div>
                  </div>
               </a>
               ) : (
               <div class="nav-card nav-card-empty older-post">
                  <div class="nav-card-direction">Plus ancien →</div>
                  <div class="nav-card-empty-message">Pas d'article plus ancien</div>
               </div>
               )}
            </div>
         </div>
      </nav>

   </div>

</Layout>

<script is:inline>
   function shareGallery(url) {
      if (navigator.share) {
         navigator.share({
            title: 'Galerie Photo',
            text: 'Découvrez cette galerie photo',
            url: url
         }).catch(console.error);
      } else {
         navigator.clipboard.writeText(url).then(() => {
            alert('Lien copié dans le presse-papiers !');
         }).catch(() => {
            alert('Impossible de copier le lien. Veuillez le copier manuellement : ' + url);
         });
      }
   }
</script>