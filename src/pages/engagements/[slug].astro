---
// src/pages/engagements/[slug].astro
// This file handles dynamic routing for individual engagement entries.

// ADD THIS LINE: This tells Astro to pre-build this page at build time.
export const prerender = true;

import Layout from '../../layouts/Layout.astro';
// 1. --- IMPORTANT CHANGE HERE --- Add 'render' to the import list
import { getCollection, type CollectionEntry, render } from 'astro:content';

// getStaticPaths is required for static site generation (SSG) in Astro.
// It tells Astro which pages to build at compile time.
export async function getStaticPaths() {
  // Fetch all entries from the 'engagements' content collection.
  const engagementEntries = await getCollection('engagements');
  // Map each entry to a path object, including the slug as a parameter.
  return engagementEntries.map((entry: CollectionEntry<'engagements'>) => ({
    params: { slug: entry.slug }, // The slug is used to generate the URL path
    props: { entry },             // Pass the current engagement entry as a prop.
  }));
}

// Explicitly type the destructured props
interface Props {
  entry: CollectionEntry<'engagements'>;
}

// Access the specific engagement entry data from 'Astro.props'.
const { entry } = Astro.props as Props;

// 2. --- IMPORTANT CHANGE HERE --- Call render as a function
const { Content } = await render(entry);
---

<Layout title={entry.data.title}>
   <div class="header-spacer"></div>
   <article class="container-medium">
      <div class="row">
         <div class="col-md-4">
            <div class="text-wrap text-right mt-1">
               <div class="title-wrapper">
                  <h1>{entry.data.title}</h1>
               {entry.data.subtitle &&
               <p>{entry.data.subtitle}</p>
               }
               </div>
               <div class="spacing-1">
                  {entry.data.link_url && entry.data.link_text && (
                     <a href={entry.data.link_url} class="link mt-1 d-inline-block">{entry.data.link_text}</a>
                     )}
                     {entry.data.gallery_url && (
                  <p><a href="#gallery" class="link">Galerie photo</a></p>
              )}
               </div>
            </div>
         </div>
         <div class="col-md-8">
            <div class="text-wrapper mb-5">
               <Content />
            </div>
            {(entry.data.secondary_image || entry.data.main_image) && (
            <div class="image-wrapper mb-4">
               <img
               src={entry.data.secondary_image || entry.data.main_image}
               alt={entry.data.title}
               width="1200"
               height="800"
               class="image-wrapper"
               />
            </div>
            )}
         </div>
      </div>
      {entry.data.gallery_url && (
      <section id="gallery">
         <div class="gallery-header">
            <h2 class="visually-hidden">Galerie - {entry.data.title}</h2>
            <div class="gallery-actions">
               <button class="gallery-action-btn" onclick={`shareGallery('${entry.data.gallery_url}')`} title="Partager la galerie">
                  <svg viewBox="0 0 24 24">
                     <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                  </svg>
               </button>
               <a href={entry.data.gallery_url} target="_blank" class="gallery-action-btn" title="Ouvrir dans un nouvel onglet">
                  <svg viewBox="0 0 24 24">
                     <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                  </svg>
               </a>
            </div>
         </div>
         <div class="lightroom-gallery">
            <iframe
            src={entry.data.gallery_url}
            width="100%"
            height="600"
            frameborder="0"
            allowfullscreen
            title={`Lightroom Gallery for ${entry.data.title}`}
            ></iframe>
         </div>
      </section>
      )}
   </article>
</Layout>

<script is:inline>
   function shareGallery(url) {
      if (navigator.share) {
         navigator.share({
            title: 'Galerie Photo',
            text: 'Découvrez cette galerie photo',
            url: url
         }).catch(console.error);
      } else {
         navigator.clipboard.writeText(url).then(() => {
            alert('Lien copié dans le presse-papiers !');
         }).catch(() => {
            alert('Impossible de copier le lien. Veuillez le copier manuellement : ' + url);
         });
      }
   }
</script>