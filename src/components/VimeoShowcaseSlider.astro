---
// src/components/VimeoShowcaseSlider.astro
// Import the CSS files
import '../styles/components/vimeo.css';
import '../styles/components/slider.css';

interface Props {
  showcaseId: string; // The ID of the Vimeo showcase
}

const { showcaseId } = Astro.props;

const uniqueId = `vimeo-slider-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="vimeo-wrapper" id={uniqueId} data-showcase-id={showcaseId}>

  <div class="vimeo-loading-placeholder">
    <p>Chargement des vidéos...</p>
    <div class="loading-spinner"></div>
  </div>

  <div class="vimeo-slider-container" style="display: none;">
    <p class="error-message" style="display: none;"></p>
    <div class="vimeo-slider-inner">
      {/* Videos will be populated by JS */}
    </div>
  </div>
  
  <div class="nav-wrapper" style="display: none;">
    <div class="slider-navigation-arrows">
      <button class="slider-arrow prev-arrow" aria-label="Previous Video">
      ⟵
      </button>
      <button class="slider-arrow next-arrow" aria-label="Next Video">
      ⟶
      </button>
    </div>
  </div>
  
</div>

<script is:inline define:vars={{ uniqueId: uniqueId }}>
  document.addEventListener('DOMContentLoaded', async () => {
    const vimeoSliderWrapper = document.getElementById(uniqueId);

    if (!vimeoSliderWrapper) {
 
      return;
    }

    const showcaseId = vimeoSliderWrapper.dataset.showcaseId;

    if (!showcaseId) {
 
      const loadingPlaceholder = vimeoSliderWrapper.querySelector('.vimeo-loading-placeholder');
      if (loadingPlaceholder) {
        loadingPlaceholder.innerHTML = '<p class="error-message">Erreur: ID de vitrine Vimeo manquant.</p>';
        loadingPlaceholder.style.color = 'red';
      }
      return;
    }

    const loadingPlaceholder = vimeoSliderWrapper.querySelector('.vimeo-loading-placeholder');
    const vimeoSliderContainer = vimeoSliderWrapper.querySelector('.vimeo-slider-container');
    const errorMessageElement = vimeoSliderContainer.querySelector('.error-message');
    const navWrapper = vimeoSliderWrapper.querySelector('.nav-wrapper');
    const sliderNavigationArrows = navWrapper.querySelector('.slider-navigation-arrows');
    const prevButton = sliderNavigationArrows.querySelector('.prev-arrow');
    const nextButton = sliderNavigationArrows.querySelector('.next-arrow');

    let videos = [];
    let errorMessage = null;

    try {
        const apiResponse = await fetch(`${window.location.origin}/api/vimeo-showcase/${showcaseId}.json`);

        if (!apiResponse.ok) {
            const errorData = await apiResponse.json();
            errorMessage = errorData.error || `Échec du chargement des vidéos (Statut: ${apiResponse.status})`;
     
        } else {
            const data = await apiResponse.json();
            // Filter out videos without embedHtml and then limit to 10
            videos = (data.videos || [])
                       .filter(video => video.embedHtml) // Filter out videos missing embedHtml
                       .slice(0, 10); // Limit to the first 10
        }
         } catch (error) {
       errorMessage = 'Erreur réseau ou impossible de se connecter à l\'API.';
     }

    loadingPlaceholder.style.display = 'none';
    vimeoSliderContainer.style.display = 'block';

    if (errorMessage || videos.length === 0) {
        errorMessageElement.textContent = errorMessage || 'Aucune vidéo trouvée pour cette vitrine.';
        errorMessageElement.style.display = 'block';
        vimeoSliderContainer.querySelector('.vimeo-slider-inner').style.display = 'none';
        navWrapper.style.display = 'none';
    }
    else {
        const vimeoSliderInner = vimeoSliderContainer.querySelector('.vimeo-slider-inner');
        vimeoSliderInner.style.display = 'flex';

        vimeoSliderInner.innerHTML = videos.map((video) => `
          <div class="vimeo-slider-card">
            <div class="vimeo-slider-player-container">
              <div class="vimeo-slider-thumbnail-wrapper" data-video-id="${video.id}" data-embed-html='${video.embedHtml.replace(/'/g, "&apos;")}' title="Play ${video.name}">
                ${video.thumbnail ? `<img src="${video.thumbnail}" alt="${video.name}" width="640" height="360" loading="lazy" />` : ''}
                <div class="vimeo-slider-play-icon-overlay">
                  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </div>
              </div>
              <div class="vimeo-slider-embed-player-active" style="display: none;">
                <div class="vimeo-slider-iframe-wrapper"></div>
              </div>
            </div>
            <h3 class="vimeo-slider-video-title">${video.name}</h3>
          </div>
        `).join('');
        const videoCards = vimeoSliderInner.querySelectorAll('.vimeo-slider-card');

        navWrapper.style.display = 'block';

        videoCards.forEach(card => {
          const thumbnailWrapper = card.querySelector('.vimeo-slider-thumbnail-wrapper');
          const playIconOverlay = thumbnailWrapper.querySelector('.vimeo-slider-play-icon-overlay');
          const videoPlayerActive = card.querySelector('.vimeo-slider-embed-player-active');
          const iframeWrapper = videoPlayerActive.querySelector('.vimeo-slider-iframe-wrapper');
          // No need to check for embedHtml here again as we've already filtered it
          const embedHtml = thumbnailWrapper.dataset.embedHtml; 

          if (thumbnailWrapper && playIconOverlay && videoPlayerActive && iframeWrapper && embedHtml) {
            playIconOverlay.addEventListener('click', (event) => {
              event.stopPropagation();
              thumbnailWrapper.style.display = 'none';
              videoPlayerActive.style.display = 'block';
              iframeWrapper.innerHTML = embedHtml;

              const iframe = iframeWrapper.querySelector('iframe');
              if (iframe && !iframe.src.includes('autoplay=1')) {
                iframe.src = iframe.src + (iframe.src.includes('?') ? '&' : '?') + 'autoplay=1';
              }
            });
          }
        });
    }

    if (vimeoSliderContainer && prevButton && nextButton && videos.length > 0) {
      const getScrollAmount = () => {
        const firstCard = vimeoSliderContainer.querySelector('.vimeo-slider-inner .vimeo-slider-card');
        if (firstCard) {
            return firstCard.offsetWidth;
        }
        return 350;
      };

      prevButton.addEventListener('click', () => {
        const scrollAmount = getScrollAmount();
        vimeoSliderContainer.scrollBy({
          left: -scrollAmount,
          behavior: 'smooth'
        });
      });

      nextButton.addEventListener('click', () => {
        const scrollAmount = getScrollAmount();
        vimeoSliderContainer.scrollBy({
          left: scrollAmount,
          behavior: 'smooth'
        });
      });
    }
  });
</script>